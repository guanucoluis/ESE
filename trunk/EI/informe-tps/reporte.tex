\documentclass[11pt,oneside,spanish,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[spanish]{babel}
\usepackage[a4paper]{geometry}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage[hyphenbreaks]{breakurl}
\usepackage[hyphens]{url}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{lstlinebgrd}
\usepackage{xcolor}
\usepackage{multicol}
\usepackage{pdfpages}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{lineno}
\usepackage{caption}
\usepackage{subcaption}

%%%%%%%%%%%%%%%%%%%%
% Nuevos comandos  %
%%%%%%%%%%%%%%%%%%%%
\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}

\hypersetup{
    pdfcreator={pdfLaTeX},   % creator of the document
    colorlinks=true,       % false: boxed links; true: coloblue links
    linkcolor=blue,          % color of internal links (change box color with linkbordercolor)
    citecolor=blue,        % color of links to bibliography
    filecolor=blue,      % color of file links
    urlcolor=blue           % color of external links
}

\pagestyle{fancy}
\addtolength{\textheight}{2cm}
%\addtolength{\voffset}{-1cm}
%\addtolength{\textwidth}{1cm}

\definecolor{light-gray}{gray}{0.9}

\lstset{
  basicstyle=\ttfamily\color{red},%\footnotesize,%\scriptsize,
  language=tcl,
  breaklines=true,
  otherkeywords={+++},
  numbers=left,
  numberstyle=\scriptsize\color{black}
}

\renewcommand{\lstlistingname}{Código}

\lstset{literate=
  {á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1
  {Á}{{\'A}}1 {É}{{\'E}}1 {Í}{{\'I}}1 {Ó}{{\'O}}1 {Ú}{{\'U}}1
  {à}{{\`a}}1 {è}{{\'e}}1 {ì}{{\`i}}1 {ò}{{\`o}}1 {ù}{{\`u}}1
  {À}{{\`A}}1 {È}{{\'E}}1 {Ì}{{\`I}}1 {Ò}{{\`O}}1 {Ù}{{\`U}}1
  {ä}{{\"a}}1 {ë}{{\"e}}1 {ï}{{\"i}}1 {ö}{{\"o}}1 {ü}{{\"u}}1
  {Ä}{{\"A}}1 {Ë}{{\"E}}1 {Ï}{{\"I}}1 {Ö}{{\"O}}1 {Ü}{{\"U}}1
  {â}{{\^a}}1 {ê}{{\^e}}1 {î}{{\^i}}1 {ô}{{\^o}}1 {û}{{\^u}}1
  {Â}{{\^A}}1 {Ê}{{\^E}}1 {Î}{{\^I}}1 {Ô}{{\^O}}1 {Û}{{\^U}}1
  {œ}{{\oe}}1 {Œ}{{\OE}}1 {æ}{{\ae}}1 {Æ}{{\AE}}1 {ß}{{\ss}}1
  {ç}{{\c c}}1 {Ç}{{\c C}}1 {ø}{{\o}}1 {å}{{\r a}}1 {Å}{{\r A}}1
  {€}{{\EUR}}1 {£}{{\pounds}}1 {"}{{``}}1
}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%
% Carátula del informe  %
%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{titlepage}
\begin{center}

\textsc{\LARGE Instituto Universitario Aeronáutico}\\[0.5cm]
\textsc{\LARGE Especialización en Sistemas Embebidos}\\[2cm]

\includegraphics[width=0.2\textwidth]{img/logo_f_blanco}~\\[2cm]

\textsc{\Large Entornos Inalámbricos}\\[0.5cm]

\HRule \\[0.4cm]
{ \huge \bfseries Trabajos Prácticos \\[0.4cm] }

\HRule \\[1.5cm]

% Author and supervisor
\begin{minipage}{0.4\textwidth}
\begin{flushleft} \large
\emph{Alumno:}\\
Luis Alberto \textsc{Guanuco}\\
Santiago Nicolás \textsc{Nolasco}\\
Sebastian \textsc{Agüero}\\
Franco \textsc{Bocalon}
\end{flushleft}
\end{minipage}
\begin{minipage}{0.4\textwidth}
\begin{flushright} \large
\emph{Docentes:} \\
Víctor \textsc{Frison}\\
Julio \textsc{Echevarría}\\
José \textsc{Ducloux}
\end{flushright}
\end{minipage}
\vfill
{\large Septiembre 2016}

\end{center}
\end{titlepage}

%\lhead{Luis A. Guanuco}
%\chead{\includegraphics[width=0.02\textwidth]{images/logoUTN}}
%\rhead{Arquitectura Embebidas y Proceso de Tiempo Real}
\section{Introducción}
\label{sec:intro}

Se realizarán ejercitaciones sobre plataformas XBee con el objetivo
de entender los \emph{Entornos Inalámbricos}. Se trabajará con los
modos \emph{AT} y \emph{API} a fin de comprar las ventajas y
desventajas de estos. Estos ejemplos prácticos servirán, además,
alcanzar la resolución del \emph{Trabajo Final}.

\subsection{Módulos XBee S2C}
\label{sec:xbee-mod}

Para el establecimiento de una red basado en los estándares 802.15.4
se plantea como requisito la disponibilidad de módulos que implementen
dicho estándar. En nuestro caso se utilizarán los módulos \emph{XBee
  S2C}\footnote{\burl{http://www.digi.com/support/productdetail?pid=4838}}. Las
principales características de estos dispositivos son:
\begin{itemize}
\item Velocidades de datos
  \begin{itemize}
  \item RF 250 Kbps
  \item Comunicación serial hasta 1 Mbps
  \end{itemize}
\item Alcances
  \begin{itemize}
  \item \textsl{Indoor} 60 metros
  \item \textsl{Outdoor} 1200 metros
  \end{itemize}
\item Potencia de transmisión 3.1 mW (+5 dBm). En modo \textsl{Boost}
  6.3 mW (+8 dBm)
\item Sensibilidad de recepción -100 dBm. EN modo \textsl{Boost} -102
  dBm
\item Banda de frecuencia 2.4 GHz (16 canales)
\item 15 puertos digitales I/O (4 entradas analógicas)
\item Alimentación 2.1V a 3.6V. Consumos:
  \begin{itemize}
  \item En la transmisión 33 mA @ 3.3 VDC. En modo \textsl{Boost}45 mA
  \item En la recepción 28 mA @ 3.3 VDC. En modo \textsl{Boost} 31 mA
  \end{itemize}
\end{itemize}

Los puntos anteriores solo describen las principales características
de los módulos XBee 2SC. Para conocer más en detalle se puede acceder
a la hoja de datos disponible en el sitio web del fabricante
\cite{s2c-ds}.

\subsection{Plataformas adicionales}
\label{sec:plat}

Se utilizará \textsl{hardware} adicional que permita establecer la
comunicación de los módulos XBee con una computadora. Sí bien el
Laboratorio de Sistemas embebidos pone a disposición las plataformas
XBoard\footnote{\burl{http://www.cika.com/soporte/Information/Digi-RF/XBee/}}
se necesita adaptar la comunicación serial del módulo XBee con la la
computadora mediante una puerto USB. Para esto se desarrolló la placa
\emph{XBee-MCP Adapter} (Figura \ref{fig:xb-mcp-adap}). Sobre esta
placa se montarán dos módulos, una es el módulo XBee y el otro es la
placa \emph{MCP2200 Breakout
  Module}\footnote{\burl{http://www.microchip.com/DevelopmentTools/ProductDetails.aspx?PartNO=adm00393}}. Este
último proporciona una comunicación serial USB-UART. 
Además se agregaron dos LEDs conectados a los puertos
\texttt{AD1/DIO1} y \texttt{AD2/DIO2}. Opcionalmente se puede conectar
un potenciómetro al conector \texttt{K1} que se encuentra mapeado al
puerto analógico de la XBee, \texttt{AD0/DIO0}.

\begin{figure}[ht]
  \centering
  \includegraphics{img/xb-mcp-adapter}
  \caption{Placa XBee-MCP Adapter.}
  \label{fig:xb-mcp-adap}
\end{figure}

La Xboard, anteriormente mencionada, es una plataforma desarrollada
por la empresa Cika Electrónica SRL. La XBoard permite interconectar
los módulos XBee con dispositivos externos \cite{xboard}. En la Figura
\ref{fig:xboard} se presenta una vista superior de la XBoard. Se puede
ver que esta placa tiene un conector hembra con las señales de
comunicación serial, niveles de tensión y otras más. Para conectar la
XBoard a una computadora se utiliza la placa MCP2200 Breakout
Module. Al no requerir componentes externos, se utilizan simplemente
cables que realicen la interconexión de las señales de comunicación
serial.

\begin{figure}[ht]
  \centering
  \includegraphics[width=.6\textwidth]{img/xboard}
  \caption{Placa XBoard.}
  \label{fig:xboard}
\end{figure}

Todas las características y configuraciones de las diferentes
plataformas comerciales  se encuentran en la bibliografía referenciada
al final de este documento. 

Se desarrollarán tres tipos de ejercitaciones. La primera sobre los
alcances de RF que proporcionan estos dispositivos. La segunda parte
sobre el manejo de los módulos en modo AT. Y por último se trabajará
en modo API con los módulos sobre una red ZigBee completa. Se
documentarán todos las implementaciones y por último se presentará una
conclusión sobre lo hecho.

\section{C\'alculo de enlace y modelos de propagaci\'on}
\label{S:1}

El dise\~no de un radioenlace implica toda una serie de c\'alculos que pueden resultar sencillos o complicados, dependiendo de las caract\'eristicas del sistema y del tipo de problema al que nos enfrentemos.

Es por ello que podemos dividir la propagaci\'on de la se\~nal de acuerdo al entorno donde esta viaje: 

\begin{itemize}
\item Espacios abiertos 
\item Entornos cerrados
\end{itemize}


\subsection{Distancia m\'axima en espacios abiertos}

 La comunicaci\'on "outdoor" en este problema se asume en un entorno de propagaci\'on libre, donde no existen p\'erdidas atmosf\'ericas, de polarizaci\'on y de desadaptaci\'on de impedancias, es decir, operamos en regiones descubiertas. 
 
% \begin{figure}[h]
% 	%\DeclareGraphicsExtensions{.pdf,.png,.jpg,.ppm}
% 	\centering\includegraphics[width=0.8\linewidth]{Image}
% 	\caption{Primer zona de Fresnel}
% \end{figure}

\begin{table}[h]
\centering
\begin{tabular}{l l l}
\hline
\textbf{Modo de funcionamiento} & \textbf{Normal} & \textbf{Boost}\\
\hline
Potencia de Tx & +5dBm(3.1mW) & +8dBm(6.3mW) \\
Sensibilidad de Rx & -100dBm & -102dBm\\
\hline
\end{tabular}
\caption{Technical review Xbee ZB}
\end{table}
Para los c\'alculos siguientes se tomar\'an los datos de funcionamiento en modo "Normal".

Partiendo de la ecuaci\'on de Friis

%\begin{equation}
%\label{Ecuaci\'on de Friis}

%Pr = \frac{Pt Gt Gr \lambda ^{2}}{(4\pi R)^2}

%\end{equation}

\begin{equation*}
\label{Ec:Friis}
Pr = \frac{Pt Gt Gr \lambda ^{2}}{(4\pi d)^2}
\end{equation*}
Siendo Pr (Potencia recibida), Pt(Potencia transmitida), Gt(Ganancia de antena tx), Gr(Ganancia de antena rx), $\lambda$(longitud de onda) y d(distancia radial entre antenas).

Podemos despejar la atenuaci\'on de espacio libre, tambi\'en conocida como p\'erdida de trayectoria.
\begin{equation*}
\label{Ec:perdida}
P_{Loss}[dB] = 94.4 + 20 \log_{10}d [Km] + 20 \log_{10}f [GHz] - Gt[dBi] - Gr[dBi]
\end{equation*}
	Y de esta despejar la m\'axima distancia
\begin{equation*}
\label{Ec:distancia}
d[Km] = 10^{\frac{P_{Loss} + Gt + Gr - 20 \log_{10}f - 92.4}{20}}
\end{equation*}
$P_{Loss}=Gt[dBm] - Gr[dBm] = +5dBm - (-100dBm) = 105dBm$
$f = 2.4 [GHz]$
Las ganancias Gr[dBi] y Gr[dBi] se toman como valor cero por ser antenas omnidireccionales.
\begin{equation*}
\label{Ec:distancia1}
d[Km] = 10^{\frac{105 dBm - 20 \log_{10}2.4 - 92.4}{20}} = 1.77 [Km] =1770m
\end{equation*}	
Con la m\'axima distancia $d$ del radioenlace, calculamos la altura $r$ de las antenas. Para ello nos valemos de las f\'ormulas del primer elipsoide de Fresnel, esto es determinando la zona libre de obstaculos.
\begin{equation*}
\label{Ec:fresnel}
r = F1(m) = 17.32 \sqrt{\frac{(d[Km]/2)^2}{d[Km]f[GHz]}} = 17.32 \sqrt{\frac{(1.77Km/2)^2}{1.77Km2.4GHz}} = 7.43m
\end{equation*}	

Por lo tanto la altura de las antenas, es decir para establecer una comunicaci\'on punto a punto a distancia m\'axima $d=1.77Km$ entre 2 XBee es de $r=7.43$ en la zona libre de obstaculos.

\subsection{Distancia m\'axima en entornos cerrados}

La propagaci\'on "indoor" difiere respectos a los sistemas "outdoor". Para asegurar una eficiente comunicaci\'on interior, la ITU a llevado una serie de propuestas para el caso de comunicaciones punto a punto. Debido a que en una comunicaci\'on en entornos cerrados esta muy influenciada por la geometr\'ia del lugar y los objetos en ella. Tanto estos objetos y la construcci\'on de la misma, ocasionan p\'erdidas por reflexiones, dispersi\'on y absorci\'on de las se\~nales RF.  

\begin{figure}[h]
%\centering\includegraphics[width=0.4\linewidth]{placeholder}
\caption{Figure caption}
\end{figure}

\subsubsection{C\'alculo Planta alta}
Para el c\'alculo de m\'axima distancia, como lo indica la figura. Nos valdremos de la f\'ormula de "path loss"
\begin{equation*}
\label{eq:pathLoss}
L_{Loss}[dB] = L_{do}[dB] + N \log_{10}d/do + Lf_{n}[dB]
\end{equation*}
Donde $N$(Coef. de p\'erdida), $f$(Frecuencia en Mhz),$d$(Distancia entre base y terminal), $L_{do}$(P\'erdida a do), $L_{f}$(Atenuaci\'on trav\'es del piso), $d0$(distancia de ref=1m) y $n$(nro de pisos entre terminal y base).
En nuestro caso particular al igual que en el caso anterior, calculamos la m\'axima atenuaci\'on:
$L_{Loss}= Gt - Gr = +5dBm - (-100dBm) = 105dBm$
$N=28$ Por dato de tabla (Espacio residencial a 2.4GHz).
$L_{do} = 20 \log_{10}f[MHz] - 28 = 39.6dB$
$Lf_{n} = 0$ Por ser un mismo piso.
Despejando d
\begin{equation*}
\label{eq:calculod}
d[m] = 10 ^{\frac{L_{Loss}[dB] - L_{do}[dB] - L_{f}[dB]}{N}} 
d[m] = 10 ^{\frac{105dBm - 39.6dB - 0}{28}} = 216.62m
\end{equation*}
Entonces en un piso la distancia m\'axima de transmisi\'on es $d=216.62m$

\subsubsection{C\'alculo de comunicaci\'on entre Planta alta y baja}
En este caso la m\'axima distancia $d$, ser\'a influenciada por la atenuaci\'on del piso, como separaci''on de los dos ambientes. Por lo tanto $L_{f}[dB]=5$ dado por el cuadro. La distancia m\'axima ser\'a.
\begin{equation*}
\label{eq:calculod}
d[m] = 10 ^{\frac{L_{Loss}[dB] - L_{do}[dB] - L_{f}[dB]}{N}} 
d[m] = 10 ^{\frac{105dBm - 39.6dB - 5}{28}} = 143.59m
\end{equation*}
Se puede notar aqu\'i, que el valor de $d$ distancia m\'axima es
reducido por esta atenuaci\'on. Siendo el valor de $d=143.59m$ para
comunicaciones entre dos pisos.

\section{Ejercitación en modo AT}
\label{sec:AT}

El set de comandos AT, también conocidos como set de comandos Hayes,
fue originalmente desarrollado para usar con los modem de Hayes en la
década de 1980. Muchos modems modernos todavía utilizan este
estándar. EL término \emph{comando AT}  viene de usar los caracteres
ASCII para notificar al \textsl{host}  que un le sigue un comando. 

En el caso de los módulos XBee desarrollados por Digi, implementa un
set de comandos propieratrios para interactuar con los módulos de
Digi a través de una comunicación serial. Basado en el set de comandos
AT, Dii usa los caracteres \texttt{AT} antes de cada comando enviado
al modem. Un ejemplo de un comando utilizado por el radio Digi XBee
podría ser \texttt{ATCH}. Este comando es usado para leer o setear el
canal que un radio XBeee es configurado\cite{at-cmds}.

\subsection{Configuración de puertos GPIO}
\label{sec:config-at}

La configuración de los diferentes canales de propósitos generales se
puede realizar utilizando el software XCTU en modo gráfico pero el
objetivo es realizarlo mediante el set de comandos AT. 

\subsubsection{Comando ATIS}
\label{sec:atis}

El comando \texttt{ATIS} fuerza la lectura de todos los canales
habilitados. Analógicos como digitales. En nuestro caso tenemos la
siguiente salida a la petición.

\begin{lstlisting}[emph={+++,ATIS}, emphstyle={\color{blue}}]
+++
OK
ATIS
01
0006
01
0000
0219
\end{lstlisting}

La respuesta que entrega el módulo comienza en la línea \textbf{4}
hasta la \textbf{8}. El primer byte \texttt{01} es la cantidad de
muestra recibidas. En la línea \textbf{5} se tiene configuración de
los canales digitales y la línea \textbf{6} canales analógicos. Para
entender se debe analizar a nivel de bits cada una de las
respuestas. Recuerde que los valores representados están en
hexadecimal. En el primer se tiene $0006_{HEX} =
000000000000110_{BIN}"$ por lo los canales \texttt{DIO1} y
\texttt{DIO2} se encuentran habilitados y configurados como salidas
digitales. Mientras que para los canales analógicos tenemos
$01_{HEX} = 0001_{BIN}$ solo el puerto \texttt{AD0} habilitado. Para
terminar el análisis de la respuesta al comando \texttt{ATIS}, las
líneas \textbf{7} y \textbf{8} son el estado de los canales
digitales y analógicos respectivamente. Como se mencionó
anteriormente, puede visualizarse la configuración de los canales de
I/O en forma gráfica desde el software XCTU. En la Figura
\ref{fig:xctu-setup} se puede ver la misma información que
proporciona el comando \texttt{ATIS}.

\begin{figure}[ht]
  \centering
  \includegraphics[width=.8\textwidth]{img/xctu-atis}
  \caption{Configuración de los GPIO en modo gráfico.}
  \label{fig:xctu-setup}
\end{figure}

Para dar comienzo con la ejercitación pedida por los docentes, se
deshabilitarán todos los canales de forma tal que el módulo quede sin
ningún GPIO en uso. Sí la configuración es tal como la descrita
anteriormente, se deben aplicar los comandos siguientes.

\noindent\begin{minipage}{.25\textwidth}
\begin{lstlisting}[emph={+++,ATIS,ATD00,ATD10,ATD20,ATWR,ATAC}, emphstyle={\color{blue}}]
+++OK
ATD00
OK
ATD10
OK
ATD20
OK
ATAC
OK
ATWR
OK
ATIS
ERROR
\end{lstlisting}
\end{minipage} \hfill
\begin{minipage}{.70\textwidth}
Para deshabilitar un canal digital/analógico se debe simplemente pasar
como último argumento el valor \texttt{0}. Esto se aplica a los
canales \texttt{DIO0}, \texttt{DIO1} y \texttt{DIO2}. Los comandos que
le siguen son para aplicar los cambios y liberar los \textsl{buffers}
(\texttt{ATAC}) y  escribir la
memoria no-volatil del módulo (\texttt{ATWR}). Al finalizar los
cambios se envía el comando \texttt{ATIS} y se tiene como respuesta
\texttt{ERROR} esto no se debe a un problema de comunicación sino que
al no existir ningún canal habilitado, no puede ofrecer información
alguna. 
\end{minipage}

A continuación se presentan diferentes configuraciones sobre el módulo
XBee montado en la placa XBoard.

\subsubsection{Configurar canales analógicos}

\noindent\begin{minipage}{.35\textwidth}
\begin{lstlisting}[emph={+++,ATIS,ATD02,ATD12,ATWR,ATAC},
    emphstyle={\color{blue}},caption={Canales analógicos.},label=code:2adc]
    +++OK
    ATD02
    OK
    ATD12
    OK
    ATAC
    OK
    ATWR
    OK
    ATIS
    01
    0000
    03
    0268
    0208
\end{lstlisting}  
\end{minipage}\hfill
\begin{minipage}{.60\textwidth}
En el código \ref{code:2adc} se configuran los canales \texttt{DIO0}
y \texttt{DIO1} como analógicos. El último parámetro define este
comportamiento. Luego de guardar la configuración se envía el comando
\texttt{ATIS} para tener la configuración final de todos los
canales. Aquí se puede ver en la línea \textbf{13} no se tiene ningún
canal digital. y en las líneas \textbf{15} y \textbf{16} se ven los
valores de los ADC correspondientes a los canales \texttt{DIO0} y
\texttt{DIO1}.
\end{minipage}

\subsubsection{Configurar canales digitales}
En el caso del código \ref{code:2do} se configuran los canales
\texttt{DIO2} y \texttt{DIO5} como salida. La elección de estos
canales se debe al circuito implementado por la placa XBoard. El
parámetro adicional en los comandos \textbf{3} y \textbf{5} es el
estado digital que se le asignará. El número \texttt{4} aplica un
valor \emph{bajo} mientras que el valor \texttt{5} define un estado
en \emph{alto}.  Al igual que en el caso anterior, el comando
\texttt{ATIS} muestra los estados de los puertos habilitados, en este
caso no tenemos entradas analógicas por lo tanto en la línea
\textbf{14} tenemos 0. 

El código \ref{code:2di}  muestra la configuración de dos canales
digitales de entrada. La diferencia con el caso anterior es el
parámetro asignado. En las líneas \textbf{3} y \textbf{5} el parámetro
es \texttt{3} que configura los canales \texttt{DIO2} y \texttt{DIO4}
como entradas digitales. 

\noindent\begin{minipage}{.45\textwidth}
\begin{lstlisting}[emph={+++,ATIS,ATD25,ATD55,ATWR,ATAC},
    emphstyle={\color{blue}}, caption={Dos salidas
      en alto.}, label=code:2do]
    +++OK
    ATD25
    OK
    ATD55
    OK
    ATAC
    OK
    ATWR
    OK
    ATIS
    01
    0024
    00
    0024
\end{lstlisting}  
\end{minipage}\hfill
\begin{minipage}{.45\textwidth}
\begin{lstlisting}[emph={+++,ATIS,ATD23,ATD43,ATWR,ATAC},
    emphstyle={\color{blue}}, caption={Dos entradas},
 label=code:2di]
    +++OK
    ATD23
    OK
    ATD43
    OK
    ATAC
    OK  
    ATWR
    OK
    ATIS
    01
    0014
    00
    0014
\end{lstlisting}  
\end{minipage}

\subsubsection{Configuración combinada de la XBoard}

\noindent\begin{minipage}{.35\textwidth}
\begin{lstlisting}[emph={+++,ATIS,ATD02,ATD12,ATD25,ATD55,ATD33,ATD43,ATWR,ATAC},
emphstyle={\color{blue}}, caption={GPIO de la placa XBoard.},label=code:completo]
  +++OK
  ATD02
  OK
  ATD12
  OK
  ATD25
  OK
  ATD55
  OK
  ATD33
  OK
  ATD43
  OK
  ATAC
  OK
  ATWR
  OK
  ATIS
  01
  003C
  02
  003C
  0264
\end{lstlisting}  
\end{minipage}\hfill
\begin{minipage}{.60\textwidth}
Finalmente configuraremos la placa XBoard con todos los modos
anteriormente vistos. Los comandos aplicados desde la línea \textbf{2}
hasta la \textbf{12} ya fueron descritos. Como respuesta al comando
\texttt{ATIS} se puede ver todos los canales digitales habilitados
(\texttt{003C}). Mientras que se tiene dos canales analógicos
\texttt{02} y sus respectivos valores en las líneas \textbf{22} y
\textbf{23}.
\end{minipage}
\section{Ejercitación en modo API}
\label{sec:API}
\newpage{}

\section{Enlaces entre módulos XBee}
\label{sec:enlace}

Ya se mostraron en las secciones anteriores las diferentes formas de
manipular los módulos XBee. En esta sección se desarrollarán pruebas
de enlace de los módulos. Las características de radio frecuencia no
son objeto de estudio, se busca evaluar las virtudes en la red que
implementa el estándar 802.15.4. Se utilizará la topología más
sencilla del alcance de las redes Zigbee. Se implementará un
\emph{Coordinador} y los demás serán configurados como
\emph{Dispositivos finales}. En la Figura \ref{xbee-red} se presenta
una red de módulos XBee en las que se puede ver las diferentes
roles que pueden asumir estos dispositivos. A parte de los dos modos
anteriormente nombrados se puede configurar en modo \emph{router} que
permite extender la red. 

\begin{figure}[ht]
  \centering
  \includegraphics[width=.8\textwidth]{img/xbee-topo}
  \caption{Red de módulos XBee con sus diferentes configuraciones.}
  \label{fig:xbee-red}
\end{figure}

\subsection{Asignación de Identificador y Función de los módulos}

Antes de comenzar con la configuración de la red, se definirá a uno de
los módulos como coordinador y los demás como dispositivos
finales. Además proporcionaremos un nombre para identificarlos a cada
uno ellos. En la línea \textbf{4} del código
\ref{code:coordinador-id}  se habilita el modo coordinador y luego se
asigna el nombre \texttt{COORDINADOR} al módulo (línea \textbf{8}.
 Como en los casos anteriores, seimpre se debe aplicar los cambios (\texttt{ATAC}) y
finalmente escribir en la memoria no-volatil (\texttt{ATWR}).
\begin{lstlisting}[emph={+++,ATCE,ATCE1,ATWR,ATAC,ATNI,ATCOORDINADOR},
    emphstyle={\color{blue}}, caption={Obtención del \textsl{seral
number}.}, label=code:coordinador-id]
+++OK
ATCE
0
ATCE1
OK
ATCE
1
ATNICOORDINADOR
OK
ATNI
COORDINADOR
ATAC
OK
ATWR
OK
\end{lstlisting}  

\subsection{Configuración de la red de área personal}

Las redes ZigBee se las llaman PANs (\textsl{Personal Area
  Networks}). Cada red es definida con un único identificador PAN, por
lo que todos los dispositivos que quieran pertenecer a la red deben
tener el mismo \texttt{ID PAN}. 

ZigBee soporta tanto PAN ID de 16 a 64 bits. Ambos PAN IDs son
utilizados como único identificador de la red. Los dispositivos que
quieran integrar la misma red deberán compartir el mismo PAN IDs. 

En el código \ref{code:pan-id} se asigna el PAN ID \texttt{260816} al
módulo coodinador y será el mismo que utilizarán los demás
dispositivos para conectarse a la red ZigBee. En la línea \textbf{2}
se solicita el actual PAN ID y el módulo responde \texttt{0}. Luego se
aplica el identificador \texttt{260816}, se utilizan solo 24 de los
los 64 bits disponibles. 

\begin{lstlisting}[emph={+++,ATWR,ATAC,ATID,ATID260816},
    emphstyle={\color{blue}}, caption={Obtención del \textsl{seral
number}.}, label=code:coordinador-id]
+++OK
ATID
0
ATID260816
OK
ATID
260816
ATAC
OK
ATWR
OK
\end{lstlisting}  

\subsection{Número de serie (identificador)  los módulos}
\label{sec:id}

Cada módulo XBee tiene una número de serie de 64 bits
(\textsl{extended address}) grabado en el \textsl{hardware} por el
fabricante\footnote{Recuerde que también los XBee tienen un
  direccionamiento de 16 bits. Para mayor información ver la
  bibliografía.}. Mediante los comandos AT se puede obtener
esta dirección en dos partes. Los comandos \texttt{ATSH} y
\texttt{ATSL} devuelven la parte alta y baja respectivamente. Estos
valores se utilizan para la configuración de la red Zigbee (junto a
los valores de  los demás módulos). En
el código \ref{code:get-id}  se muestra cómo obtener el número de serie
del dispositivo al que se encuentra conectado el terminal
serial. 
\begin{lstlisting}[emph={+++,ATSH,ATSL},
    emphstyle={\color{blue}}, caption={Obtener el \textsl{serial
        number} del módulo XBee},
 label=code:get-id]
+++OK
ATSH
13A200
ATSL
41257816
\end{lstlisting}

\subsection{Configuración de direccionamiento de los dispositivos en
  una red ZigBee}

En la sección anterior se mostró como obtener las identificaciones de
cada módulo. Esta información se utiliza para mapear la red a
implementar. Se recuerda que la topología utilizada en estos
prácticos, se tendrá un coordinador y varios dispositivos finales que
proporcionarán información al primero. En este caso el coordinador
configura su dirección de destino al único (por el momento)
dispositivo conectado, código \ref{code:coord-dest}. Se cargan la
parte alta (\texttt{ATDH13A200}) y la baja (\texttt{ATDL4125768A}) con
los valores propios del dispositivo final al que se conectará el
coordinador. En forma recíproca se debe cargar el identificador del
coordinador como dirección de destino del único dispositivo final
conectado a la red. Esto último se muestra en el código
\ref{code:end-dest}. Para mejor entendimiento de los códigos de
configuración se solicita antes a los módulos responder el nombre que
identifica a los módulos y sus respectivos números de serie. Al final
se guardan todos los cambios realizados.

\noindent\begin{minipage}{.45\textwidth}
\begin{lstlisting}[emph={+++,ATWR,ATAC,ATNI,ATSH,ATSL,ATDH13A200,ATDL4125768A},
emphstyle={\color{blue}}, caption={Destino del coordinador.},label=code:coord-dest]
+++OK
ATNI
COORDINADOR
ATSH
13A200
ATSL
41257816
ATDH13A200
OK
ATDL4125768A
OK
ATAC
OK
ATWR
OK
\end{lstlisting}  
\end{minipage}\hfill
\begin{minipage}{.45\textwidth}
\begin{lstlisting}[emph={+++,ATWR,ATAC,ATSH,ATNI,ATSL,ATDH13A200,ATDL41257816},
emphstyle={\color{blue}}, caption={Destino del coordinador.},label=code:end-dest]
+++OK
ATNI
DISPOSITIVO1
ATSH
13A200
ATSL
4125768A
ATDH13A200
OK
ATDL41257816
OK
ATAC
OK
ATWR
OK
\end{lstlisting}  
\end{minipage}

\subsection{Comunicación entre computadoras mediante módulos XBee}

Con los módulos configurados anteriormente para establecer una
comunicación punto a punto, se probará el enlace entre los módulos
comunicando ambos módulos entre sí mediante un terminal de
computadora. Es decir, se utilizarán dos computadoras conectando sus
respectivos puertos seriales (RS232) a cada módulo XBee ya
configurados. A continuación se presentan las capturas de pantalla de
dos terminales. En la Figura \ref{fig:term-coord} se muestran la
consola de XCTU del coordinador. Mientras que en la Figura
\ref{fig:term-end} se ven los mensajes recibidos desde el terminal del
dispositivo conectado a la red ZigBee (\texttt{DISPOSITIVO 1}).

\begin{figure}[ht]
  \centering
  \begin{subfigure}{0.8\textwidth}
    \centering
    \includegraphics[width=\textwidth]{img/terminal-coord}
    \caption{Consola con el módulo coordinador.}
    \label{fig:term-coord}
  \end{subfigure}
  % --
  \begin{subfigure}{0.8\textwidth}
    \centering
    \includegraphics[width=\textwidth]{img/terminal-dispo}
    \caption{Consola con el módulo conectado a la red.}
    \label{fig:term-end}
  \end{subfigure}
  % --
  \caption{Captura de pantalla de las consolas utilizando XCTU.}
  \label{fig:terminales}
\end{figure}

\section{Control remoto de los módulos XBee}
\label{sec:remoto}

En la Sección \ref{TODO} se realizaron pruebas de los módulos en modo
API. Este modo introduce complejidad pues debe generarse una trama
específica pero de esta forma se logra mayores prestaciones por parte
de los módulos. 

En el siguiente ejemplo se describirá el mecanismo por el cual se
configura el comportamiento de un módulo XBee en forma remota desde
otro. Los módulos debe estar ya configurados como se describió
anteriormente. Se utilizará el \emph{Generador de Frames}, aplicativo
del software XCTU. 

En la Figura \ref{fig:remotos-dio5} se capturan la generación de
comandos enviados desde el módulo coordinador a uno de sus
dispositivos conectados. Primero se releva el estado del módulo, esto
con el comando \texttt{ATIS} (Fig. \ref{fig:remoto-atis}). Aquí se
ingresa la dirección destino del módulo al que se le enviará el
comando. Luego de chequear el estado de los puertos se enviará un
comando para asignar un estado bajo al puerto \texttt{DIO5}
(Fig. \ref{fig:remoto-atd54}). De la misma forma, se envía un comando
al puerto 5 con el cambio de estado \texttt{ATD55}
(Fig. \ref{fig:remoto-atd55}).

\begin{figure}[ht]
  \centering
  \begin{subfigure}{0.3\textwidth}
    \centering
    \includegraphics[width=\textwidth]{img/remoto-atis}
    \caption{Comando \texttt{ATIS}.}
    \label{fig:remoto-atis}
  \end{subfigure}
  % -- 
  \hfill
  \begin{subfigure}{0.3\textwidth}
    \centering
    \includegraphics[width=.86\textwidth]{img/remoto-td54}
    \caption{Comando \texttt{ATD54}.}
    \label{fig:remoto-atd54}
  \end{subfigure}
  % --
  \hfill
  \begin{subfigure}{0.3\textwidth}
    \centering
    \includegraphics[width=\textwidth]{img/remoto-atd55}
    \caption{Comando \texttt{ATD55}.}
    \label{fig:remoto-atd55}
  \end{subfigure}
  % --
  \caption{Comandos remotos desde un módulo a otro.}
  \label{fig:remotos-dio5}
\end{figure}

Los comandos AT se encuentran concatenados con los caracteres propios
de la trama definida por el API. Por lo tanto, la clave es las
funcionalidades y prestaciones del \textsl{interface}. Se podría enviar los
mismos comandos AT de la Sección \ref{sec:AT} sin problemas. Pues la
trama API identifica qué tipo de información se está enviando.


\section{Librería \texttt{xbee-arduino}}
\label{sec:lib-xbe-ano}

\section{Conclusiones}
\label{sec:conc}

La implementación de este RTOS tan específico y novedoso, por lo menos
para nosotros, nos ha permitido ampliar la concepción de sistemas
operativos en tiempo real. A la vez que se ha podido interactuar con
profesionales de la región que están en pleno desarrollo y aportes
para mejorar el código utilizado (freeOSEK). 

\begin{thebibliography}{1}
\bibitem{s2c-ds}
  Digi International,
  \emph{XBee\textsuperscript{\textregistered{}}/XBee-PRO
    ZigBee\textsuperscript{\textregistered{}} RF Module -- User
    Guide}. 2016.
  
\bibitem{xboard}
  Cika Electrónica SRL.,
  \emph{XBoard [-W]}.
  \burl{http://www.cika.com/soporte/Information/Digi-RF/XBee/XBoard_doc.pdf}.

\bibitem{at-cmds}
  Digi International,
  \emph{Knowledge Base -- The AT Command Set}.
  \burl{http://knowledge.digi.com/articles/Knowledge_Base_Article/The-AT-Command-Set}.

\end{thebibliography}

% \appendix{}

% \chapter{Códigos del programa}
% \label{chap:code-prog}

% \lstinputlisting[basicstyle=\scriptsize,title=Código de la función
% \texttt{main.c}]{src/examples/adc_dac/src/adc_dac.c}

% \lstinputlisting[basicstyle=\scriptsize,title=Código del archivo
% \texttt{proyectofinal.oil}]{src/examples/adc_dac/etc/adc_dac.oil}

% \chapter{Esquemáticos del hardware utulizado}
% \label{chap:sch}

% \includepdf[landscape=true,pages=-]{img/Schematic}

\end{document}
